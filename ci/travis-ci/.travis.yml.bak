# Copyright 2019 Jacob Hrbek <kreyren@rixotstudio.cz>
# Distributed under the terms of the GNU General Public License v3 (https://www.gnu.org/licenses/gpl-3.0.en.html) or later
# Based in part upon 'travis.yml' from rsplib	(https://raw.githubusercontent.com/dreibh/rsplib/master/.travis.yml), which is:
# 		Copyright (C) 2018-2019 by Thomas Dreibholz <dreibh@iem.uni-due.de> as GPLv3 or any other GPL at your option

# ABSTRACT
# - [X] Run tests on linux amd64
#   - [ ] Get Fuse3 for tests
#     - Tried workaround: `sudo find /etc/apt/ -type f -name *.list -exec rm {} \; && sudo wget https://gist.githubusercontent.com/Kreyren/e423ec139763469060084bdcbf08f85f/raw/21c863860dd622265aa8598fc63fffeaaa1ef1fc/dsgasdg -O /etc/apt/sources.list && sudo apt update 1>/dev/null && apt install libfuse3-dev
# - [ ] Run tests on linux arm64
# - [X] Run tests on osx
# - [X] Run tests on freebsd

language: C
sudo: required
cache:
  directories:
    - /var/cache/apt/
    - /var/cache/pbuilder/aptcache/

matrix:
  include:

  # ###### Ubuntu Linux ####################################################

  # ====== Ubuntu 19.10 (Eoan Ermine) ======================================
    - name: "Ubuntu 19.10 (Eoan Ermine) with GCC"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        DOCKER="ubuntu:eoan"
        VARIANT="ubuntu"
        TOOL="compile"
        COMPILER_C="gcc"
        COMPILER_CXX="g++"
    - name: "Ubuntu 19.10 (Eoan Ermine) with Clang"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        DOCKER="ubuntu:eoan"
        VARIANT="ubuntu"
        TOOL="compile"
        COMPILER_C="clang"
        COMPILER_CXX="clang++"
    - name: "Ubuntu 19.10 (Eoan Ermine) packaging with pbuilder"
      dist: bionic
      group: travis_latest
      env:
        DOCKER="ubuntu:eoan"
        VARIANT="ubuntu"
        TOOL="pbuilder"

  # ====== Ubuntu 19.04 (Disco Dingo) ======================================
    - name: "Ubuntu 19.04 (Disco Dingo) with GCC"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        DOCKER="ubuntu:disco"
        VARIANT="ubuntu"
        TOOL="compile"
        COMPILER_C="gcc"
        COMPILER_CXX="g++"
    - name: "Ubuntu 19.04 (Disco Dingo) with Clang"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        DOCKER="ubuntu:disco"
        VARIANT="ubuntu"
        TOOL="compile"
        COMPILER_C="clang"
        COMPILER_CXX="clang++"
    - name: "Ubuntu 19.04 (Disco Dingo) packaging with pbuilder"
      dist: bionic
      group: travis_latest
      env:
        DOCKER="ubuntu:disco"
        VARIANT="ubuntu"
        TOOL="pbuilder"

  # ====== Ubuntu 18.04 (Bionic Beaver) ====================================
    - name: "Ubuntu 18.04 (Bionic Beaver) with GCC"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        DOCKER="ubuntu:bionic"
        VARIANT="ubuntu"
        TOOL="compile"
        COMPILER_C="gcc"
        COMPILER_CXX="g++"
    - name: "Ubuntu 18.04 (Bionic Beaver) with Clang"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        DOCKER="ubuntu:bionic"
        VARIANT="ubuntu"
        TOOL="compile"
        COMPILER_C="clang"
        COMPILER_CXX="clang++"
    - name: "Ubuntu 18.04 (Bionic Beaver) packaging with pbuilder"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        DOCKER="ubuntu:bionic"
        VARIANT="ubuntu"
        TOOL="pbuilder"

  # ====== Ubuntu 16.04 (Xenial Xerus) =====================================
    - name: "Ubuntu 16.04 (Xenial Xerus) with GCC"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        DOCKER="ubuntu:xenial"
        VARIANT="ubuntu"
        TOOL="compile"
        COMPILER_C="gcc"
        COMPILER_CXX="g++"
    - name: "Ubuntu 16.04 (Xenial Xerus) with Clang"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        DOCKER="ubuntu:xenial"
        VARIANT="ubuntu"
        TOOL="compile"
        COMPILER_C="clang"
        COMPILER_CXX="clang++"
    - name: "Ubuntu 16.04 (Xenial Xerus) packaging with pbuilder"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        DOCKER="ubuntu:xenial"
        VARIANT="ubuntu"
        TOOL="pbuilder"

  # ====== Ubuntu 14.04 (Trusty Tahr) ======================================
    - name: "Ubuntu 14.04 (Trusty Tahr) with GCC"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        DOCKER="ubuntu:trusty"
        VARIANT="ubuntu"
        TOOL="compile"
        COMPILER_C="gcc"
        COMPILER_CXX="g++"
    - name: "Ubuntu 14.04 (Trusty Tahr) with Clang"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        DOCKER="ubuntu:trusty"
        VARIANT="ubuntu"
        TOOL="compile"
        COMPILER_C="clang"
        COMPILER_CXX="clang++"
    - name: "Ubuntu 14.04 (Trusty Tahr) packaging with pbuilder"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        DOCKER="ubuntu:trusty"
        VARIANT="ubuntu"
        TOOL="pbuilder"

  # ###### Debian Linux ###################################################

    # ====== Debian Testing =================================================
    - name: "Debian Testing with GCC"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        DOCKER="debian:testing"
        VARIANT="debian"
        TOOL="compile"
        COMPILER_C="gcc"
        COMPILER_CXX="g++"
    - name: "Debian Testing with Clang"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        DOCKER="debian:testing"
        VARIANT="debian"
        TOOL="compile"
        COMPILER_C="clang"
        COMPILER_CXX="clang++"
    - name: "Debian Testing packaging with pbuilder"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        DOCKER="debian:testing"
        VARIANT="debian"
        TOOL="pbuilder"

    # ====== Debian Sid ======================================================
    - name: "Debian Sid with GCC"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        DOCKER="debian:sid"
        VARIANT="debian"
        TOOL="compile"
        COMPILER_C="gcc"
        COMPILER_CXX="g++"
    - name: "Debian Sid with Clang"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        DOCKER="debian:sid"
        VARIANT="debian"
        TOOL="compile"
        COMPILER_C="clang"
        COMPILER_CXX="clang++"
    - name: "Debian Sid packaging with pbuilder"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        DOCKER="debian:sid"
        VARIANT="debian"
        TOOL="pbuilder"

    # ====== Debian Buster ===================================================
    - name: "Debian Buster with GCC"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        DOCKER="debian:buster"
        VARIANT="debian"
        TOOL="compile"
        COMPILER_C="gcc"
        COMPILER_CXX="g++"
    - name: "Debian Buster with Clang"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        DOCKER="debian:buster"
        VARIANT="debian"
        TOOL="compile"
        COMPILER_C="clang"
        COMPILER_CXX="clang++"
    - name: "Debian Buster packaging with pbuilder"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        DOCKER="debian:buster"
        VARIANT="debian"
        TOOL="pbuilder"

    # ====== Debian Stretch ==================================================
    - name: "Debian Stretch with GCC"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        DOCKER="debian:stretch"
        VARIANT="debian"
        TOOL="compile"
        COMPILER_C="gcc"
        COMPILER_CXX="g++"
    - name: "Debian Stretch with Clang"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        DOCKER="debian:stretch"
        VARIANT="debian"
        TOOL="compile"
        COMPILER_C="clang"
        COMPILER_CXX="clang++"
    - name: "Debian Stretch packaging with pbuilder"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        DOCKER="debian:stretch"
        VARIANT="debian"
        TOOL="pbuilder"

  # ###### Fedora Linux ###################################################

    ## ====== Fedora 31 =======================================================
    - name: "Fedora 31 with GCC"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        DOCKER="fedora:31"
        VARIANT="fedora"
        TOOL="compile"
        COMPILER_C="gcc"
        COMPILER_CXX="g++"
    - name: "Fedora 31 with Clang"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        DOCKER="fedora:31"
        VARIANT="fedora"
        TOOL="compile"
        COMPILER_C="clang"
        COMPILER_CXX="clang++"
    - name: "Fedora 31 packaging with mock"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        DOCKER="fedora:31"
        VARIANT="fedora"
        TOOL="mock"

    # ====== Fedora 30 =======================================================
    - name: "Fedora 30 with GCC"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        DOCKER="fedora:30"
        VARIANT="fedora"
        TOOL="compile"
        COMPILER_C="gcc"
        COMPILER_CXX="g++"
    - name: "Fedora 30 with Clang"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        DOCKER="fedora:30"
        VARIANT="fedora"
        TOOL="compile"
        COMPILER_C="clang"
        COMPILER_CXX="clang++"
    - name: "Fedora 30 packaging with mock"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        DOCKER="fedora:30"
        VARIANT="fedora"
        TOOL="mock"

    # ====== Fedora 29 =======================================================
    - name: "Fedora 29 with GCC"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        DOCKER="fedora:29"
        VARIANT="fedora"
        TOOL="compile"
        COMPILER_C="gcc"
        COMPILER_CXX="g++"
    - name: "Fedora 29 with Clang"
      os: linux
      dist: bionic
      group: travis_latest
      env:
       DOCKER="fedora:29"
       VARIANT="fedora"
       TOOL="compile"
       COMPILER_C="clang"
       COMPILER_CXX="clang++"

    - name: "Fedora 29 packaging with mock"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        DOCKER="fedora:29"
        VARIANT="fedora"
        TOOL="mock"

    #====== Fedora Rawhide ==================================================
    - name: "Fedora Rawhide with GCC"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        DOCKER="fedora:rawhide"
        VARIANT="fedora"
        TOOL="compile"
        COMPILER_C="gcc"
        COMPILER_CXX="g++"
    - name: "Fedora Rawhide with Clang"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        DOCKER="fedora:rawhide"
        VARIANT="fedora"
        TOOL="compile"
        COMPILER_C="clang"
        COMPILER_CXX="clang++"
    - name: "Fedora Rawhide packaging with mock"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        DOCKER="fedora:rawhide"
        VARIANT="fedora"
        TOOL="mock"

  # ###### FreeBSD #########################################################

    # ====== FreeBSD 12.0-RELEASE ============================================
    - name: "FreeBSD 12.0-RELEASE with Clang"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        QEMU="FreeBSD"
        VARIANT="12.0-RELEASE"
        TOOL="compile"
        COMPILER_C="clang"
        COMPILER_CXX="clang++"

    - name: "FreeBSD 12.0-RELEASE with GCC"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        QEMU="FreeBSD"
        VARIANT="12.0-RELEASE"
        TOOL="compile"
        COMPILER_C="gcc"
        COMPILER_CXX="g++"

    # ====== FreeBSD 11.3-RELEASE ============================================
    - name: "FreeBSD 11.3-RELEASE with Clang"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        QEMU="FreeBSD"
        VARIANT="11.3-RELEASE"
        TOOL="compile"
        COMPILER_C="clang"
        COMPILER_CXX="clang++"

    - name: "FreeBSD 11.3-RELEASE with GCC"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        QEMU="FreeBSD"
        VARIANT="11.3-RELEASE"
        TOOL="compile"
        COMPILER_C="gcc"
        COMPILER_CXX="g++"

    # ====== FreeBSD 11.2-RELEASE ============================================
    - name: "FreeBSD 11.2-RELEASE with Clang"
      os: linux
      dist: bionic
      group: travis_latest
      env: QEMU="FreeBSD" VARIANT="11.2-RELEASE" TOOL="compile"   COMPILER_C="clang" COMPILER_CXX="clang++"
    - name: "FreeBSD 11.2-RELEASE with GCC"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        QEMU="FreeBSD"
        VARIANT="11.2-RELEASE"
        TOOL="compile"
        COMPILER_C="gcc"
        COMPILER_CXX="g++"

  # ###### Other ###########################################################

    # ====== MacOS X =========================================================
    - name: "MacOS X"
      os: osx
      osx_image: xcode9.4
      compiler: clang
      group: travis_latest

    # ###### Special #########################################################

    - name: "Default Build"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        TOOL="compile"

    - name: "Coverity Scan"
      os: linux
      dist: bionic
      group: travis_latest
      env:
        TOOL="coverity"
        VARIANT="ubuntu"
        COVERITY_PROJECT="dreibh%2Frsplib"
        COVERITY_SCAN_NOTIFICATION_EMAIL="dreibh@simula.no"
        COVERITY_SCAN_BRANCH="coverity_scan"

before_install:
  - ci/before-install

install:
  - ci/install

script:
  - ci/build
  - ci/test


before_install:
  # FIXME: We need libfuse3-dev to make proper QA for etcfs.c
  - if [ "$TRAVIS_OS_NAME" = linux ]; then sudo apt update && sudo apt install meson cppcheck clang gcc git ninja-build bison libtool autoconf pkg-config libcap-dev indent fakeroot uthash-dev gzip rsync autopoint shellcheck -y && sudo wget https://github.com/mvdan/sh/releases/download/v3.0.0-beta1/shfmt_v3.0.0-beta1_linux_amd64 -O /usr/bin/shfmt && sudo chmod +x /usr/bin/shfmt; fi
  # FIXME: Implement MacOS tests
  - if [ "$TRAVIS_OS_NAME" = osx ]; then brew install shellcheck shfmt cppcheck; fi
  # FIXME: Implement FreeBSD tests
  - if [ "$TRAVIS_OS_NAME" = freebsd ]; then printf '%s\n' "ping"; fi
  # FIXME: Implement Redox tests as stub untill it's usable
  - if [ "$TRAVIS_OS_NAME" = redox ]; then printf '%s\n' "ping"; fi

script: make check
